# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger: none

pool:
   name: UITestPoolAzure

jobs:
  - job: Test
    steps:
      - task: AzureCLI@2
        inputs:
          azureSubscription: 'WR-VS'
          scriptType: 'pscore'
          scriptLocation: 'inlineScript'
          inlineScript: |
            $numMachines = 2

            1..$numMachines | ForEach-Object -Parallel { 
              az vm start --resource-group test-resource-group --name par-test-$_ 
            } -ThrottleLimit 4
            
            $ips = [System.Collections.ArrayList]@()
            1..$numMachines | ForEach-Object { 
                $ip = az vm list-ip-addresses --resource-group test-resource-group --name par-test-$_ --query [0].virtualMachine.network.privateIpAddresses[0] 
                $ips.Add($ip)
            }

            #Start-Sleep -Seconds 60

            Invoke-Command -ComputerName $ips -ScriptBlock {
              Start-ScheduledTask -TaskName "Run Tests"
              do{
                  $state = Get-ScheduledTask -TaskName "Run Tests"|select -expand State
                  Start-Sleep -Milliseconds 500
              } while($state -eq "Running")
            }
      - task: PublishTestResults@2
        inputs:
          testResultsFormat: 'VSTest'
          testResultsFiles: '*.trx'
          searchFolder: 'C:/Shared/'
          mergeTestResults: true
